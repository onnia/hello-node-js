"use strict";function Nodemailer(transporter){EventEmitter.call(this),this._plugins={compile:[],stream:[]},this.transporter=transporter,"function"==typeof transporter.on&&(this.transporter.on("log",this.emit.bind(this,"log")),this.transporter.on("error",this.emit.bind(this,"error")))}var Compiler=require("./compiler"),EventEmitter=require("events").EventEmitter,util=require("util"),directTransport=require("nodemailer-direct-transport"),smtpTransport=require("nodemailer-smtp-transport"),packageData=require("../package.json"),fs=require("fs"),hyperquest=require("hyperquest");module.exports.createTransport=function(transporter){return transporter=transporter||directTransport({debug:!0}),"object"==typeof transporter&&"function"!=typeof transporter.send&&(transporter=smtpTransport(transporter)),new Nodemailer(transporter)},util.inherits(Nodemailer,EventEmitter),Nodemailer.prototype.use=function(step,plugin){step=(step||"").toString(),this._plugins.hasOwnProperty(step)?this._plugins[step].push(plugin):this._plugins[step]=[plugin]},Nodemailer.prototype.close=function(){var args=Array.prototype.slice.call(arguments);"function"==typeof this.transporter.close&&this.transporter.close.apply(this.transporter,args)},Nodemailer.prototype.sendMail=function(data,callback){data=data||{},data.headers=data.headers||{},callback=callback||function(){};var mail={data:data,message:null,resolveContent:this.resolveContent.bind(this)};return"string"==typeof this.transporter?callback(new Error("Unsupported configuration, downgrade Nodemailer to v0.7.1 or see the migration guide https://github.com/andris9/Nodemailer#migration-guide")):void this._processPlugins("compile",mail,function(err){return err?callback(err):(mail.message=new Compiler(mail.data).compile(),mail.data.xMailer!==!1&&mail.message.setHeader("X-Mailer",mail.data.xMailer||this._getVersionString()),void this._processPlugins("stream",mail,function(err){return err?callback(err):void this.transporter.send(mail,callback)}.bind(this)))}.bind(this))},Nodemailer.prototype.resolveContent=function(data,key,callback){var content=data&&data[key]&&data[key].content||data[key],encoding=("object"==typeof data[key]&&data[key].encoding||"utf8").toString().toLowerCase().replace(/[-_\s]/g,"");if(!content)return callback(null,content);if("object"==typeof content){if("function"==typeof content.pipe)return this._resolveStream(content,function(err,value){return err?callback(err):(data[key]=value,void callback(null,value))}.bind(this));if(/^https?:\/\//i.test(content.path||content.href))return this._resolveStream(hyperquest(content.path||content.href),callback);if(/^data:/i.test(content.path||content.href)){var parts=(content.path||content.href).match(/^data:((?:[^;]*;)*(?:[^,]*)),(.*)$/i);return parts?callback(null,/\bbase64$/i.test(parts[1])?new Buffer(parts[2],"base64"):new Buffer(decodeURIComponent(parts[2]))):callback(null,new Buffer(0))}if(content.path)return this._resolveStream(fs.createReadStream(content.path),callback)}"string"==typeof data[key].content&&["utf8","usascii","ascii"].indexOf(encoding)<0&&(content=new Buffer(data[key].content,encoding)),callback(null,content)},Nodemailer.prototype._resolveStream=function(stream,callback){var responded=!1,chunks=[],chunklen=0;stream.on("error",function(err){responded||(responded=!0,callback(err))}),stream.on("data",function(chunk){chunk&&chunk.length&&(chunks.push(chunk),chunklen+=chunk.length)}),stream.on("end",function(){if(!responded){responded=!0;var value;try{value=Buffer.concat(chunks,chunklen)}catch(E){return callback(E)}callback(null,value)}})},Nodemailer.prototype._getVersionString=function(){return util.format("%s (%s; +%s; %s/%s)",packageData.name,packageData.version,packageData.homepage,this.transporter.name,this.transporter.version)},Nodemailer.prototype._processPlugins=function(step,mail,callback){if(step=(step||"").toString(),!this._plugins.hasOwnProperty(step)||!this._plugins[step].length)return callback(null);var plugins=Array.prototype.slice.call(this._plugins[step]),processPlugins=function(){if(!plugins.length)return callback(null);var plugin=plugins.shift();plugin(mail,function(err){return err?callback(err):void processPlugins()})}.bind(this);processPlugins()};