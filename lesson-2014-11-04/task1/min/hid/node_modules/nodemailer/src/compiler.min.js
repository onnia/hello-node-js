"use strict";function Compiler(mail){this.mail=mail||{},this.message=!1}var BuildMail=require("buildmail"),libmime=require("libmime");module.exports=Compiler,Compiler.prototype.compile=function(){return this._alternatives=this._getAlternatives(),this._htmlNode=this._alternatives.filter(function(alternative){return/^text\/html\b/i.test(alternative.contentType)}).pop(),this._attachments=this._getAttachments(!!this._htmlNode),this._useRelated=!(!this._htmlNode||!this._attachments.related.length),this._useAlternative=this._alternatives.length>1,this._useMixed=this._attachments.attached.length>1||this._alternatives.length&&1===this._attachments.attached.length,this.message=this._useMixed?this._createMixed():this._useAlternative?this._createAlternative():this._useRelated?this._createRelated():this._createContentNode(!1,[].concat(this._alternatives||[]).concat(this._attachments.attached||[]).shift()||{contentType:"text/plain",content:""}),["from","to","cc","bcc","reply-to","in-reply-to","references","subject","message-id","date"].forEach(function(header){var key=header.replace(/-(\w)/g,function(o,c){return c.toUpperCase()});this.mail[key]&&this.message.setHeader(header,this.mail[key])}.bind(this)),this.mail.headers&&this.message.addHeader(this.mail.headers),this.mail.envelope&&this.message.setEnvelope(this.mail.envelope),this.message},Compiler.prototype._createMixed=function(parentNode){var node;return node=parentNode?parentNode.createChild("multipart/mixed"):new BuildMail("multipart/mixed"),this._useAlternative?this._createAlternative(node):this._useRelated&&this._createRelated(node),[].concat(!this._useAlternative&&this._alternatives||[]).concat(this._attachments.attached||[]).forEach(function(element){this._useRelated&&element===this._htmlNode||this._createContentNode(node,element)}.bind(this)),node},Compiler.prototype._createAlternative=function(parentNode){var node;return node=parentNode?parentNode.createChild("multipart/alternative"):new BuildMail("multipart/alternative"),this._alternatives.forEach(function(alternative){this._useRelated&&this._htmlNode===alternative?this._createRelated(node):this._createContentNode(node,alternative)}.bind(this)),node},Compiler.prototype._createRelated=function(parentNode){var node;return node=parentNode?parentNode.createChild('multipart/related; type="text/html"'):new BuildMail('multipart/related; type="text/html"'),this._createContentNode(node,this._htmlNode),this._attachments.related.forEach(function(alternative){this._createContentNode(node,alternative)}.bind(this)),node},Compiler.prototype._createContentNode=function(parentNode,element){element=element||{},element.content=element.content||"";var node,encoding=(element.encoding||"utf8").toString().toLowerCase().replace(/[-_\s]/g,"");return node=parentNode?parentNode.createChild(element.contentType,{filename:element.filename}):new BuildMail(element.contentType,{filename:element.filename}),element.cid&&node.setHeader("Content-Id","<"+element.cid.replace(/[<>]/g,"")+">"),this.mail.encoding&&/^text\//i.test(element.contentType)&&node.setHeader("Content-Transfer-Encoding",this.mail.encoding),(!/^text\//i.test(element.contentType)||element.contentDisposition)&&node.setHeader("Content-Disposition",element.contentDisposition||"attachment"),"string"==typeof element.content&&["utf8","usascii","ascii"].indexOf(encoding)<0&&(element.content=new Buffer(element.content,encoding)),node.setContent(element.content),node},Compiler.prototype._getAttachments=function(findRelated){var attachments=[].concat(this.mail.attachments||[]).map(function(attachment,i){var data;return/^data:/i.test(attachment.path||attachment.href)&&(attachment=this._processDataUrl(attachment)),data={contentType:attachment.contentType||libmime.detectMimeType(attachment.filename||attachment.path||attachment.href||"bin"),contentDisposition:attachment.contentDisposition||"attachment"},attachment.filename?data.filename=attachment.filename:(data.filename=(attachment.path||attachment.href||"").split("/").pop()||"attachment-"+(i+1),data.filename.indexOf(".")<0&&(data.filename+="."+libmime.detectExtension(data.contentType))),/^https?:\/\//i.test(attachment.path)&&(attachment.href=attachment.path,attachment.path=void 0),attachment.cid&&(data.cid=attachment.cid),data.content=attachment.path?{path:attachment.path}:attachment.href?{href:attachment.href}:attachment.content||"",attachment.encoding&&(data.encoding=attachment.encoding),data}.bind(this));return findRelated?{attached:attachments.filter(function(attachment){return!attachment.cid}),related:attachments.filter(function(attachment){return!!attachment.cid})}:{attached:attachments,related:[]}},Compiler.prototype._getAlternatives=function(){var text,html,alternatives=[];return this.mail.text&&(text="object"==typeof this.mail.text&&this.mail.text.content||this.mail.text.path||this.mail.text.href?this.mail.text:{content:this.mail.text},text.contentType="text/plain"+(!text.encoding&&libmime.isPlainText(text.content)?"":"; charset=utf-8")),this.mail.html&&(html="object"==typeof this.mail.html&&this.mail.html.content||this.mail.html.path||this.mail.html.href?this.mail.html:{content:this.mail.html},html.contentType="text/html"+(!html.encoding&&libmime.isPlainText(html.content)?"":"; charset=utf-8")),[].concat(text||[]).concat(html||[]).concat(this.mail.alternatives||[]).forEach(function(alternative){var data;/^data:/i.test(alternative.path||alternative.href)&&(alternative=this._processDataUrl(alternative)),data={contentType:alternative.contentType||libmime.detectMimeType(alternative.filename||alternative.path||alternative.href||"txt")},alternative.filename&&(data.filename=alternative.filename),/^https?:\/\//i.test(alternative.path)&&(alternative.href=alternative.path,alternative.path=void 0),data.content=alternative.path?{path:alternative.path}:alternative.href?{href:alternative.href}:alternative.content||"",alternative.encoding&&(data.encoding=alternative.encoding),alternatives.push(data)}.bind(this)),alternatives},Compiler.prototype._processDataUrl=function(element){var parts=(element.path||element.href).match(/^data:((?:[^;]*;)*(?:[^,]*)),(.*)$/i);return parts?(element.content=/\bbase64$/i.test(parts[1])?new Buffer(parts[2],"base64"):new Buffer(decodeURIComponent(parts[2])),"path"in element&&(element.path=!1),"href"in element&&(element.href=!1),parts[1].split(";").forEach(function(item){/^\w+\/[^\/]+$/i.test(item)&&(element.contentType=element.contentType||item.toLowerCase())}),element):element};